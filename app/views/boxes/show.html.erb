<h3><%= @box.title %></h3>
Created on: <%= @box.created_at.strftime("%m/%d/%y") %><br>
Subscription Level: <%= @box.subscription.level %><br>
Shipped On: <%= @box.updated_at.strftime("%m/%d/%y") %><br>

<div class="items">
 <%= render 'items/items' %>
</div>

<p>
  <% if !@box.shipped %>
    <% if current_user.try(:admin?) %>
      <h2>Add an item to this box</h2>

        <%= form_for([@box, @item]) do |f| %>

        <%= render "shared/error_messages", :target => @item %>

        <div class="field">
          <%= f.label :item_name %>
          <%= f.text_field :title %><br>
        </div>

        <div class="field">
          <%= f.label :item_description %>
          <%= f.text_area :description %><br>
        </div>

        <div class="field">
          <%= f.label :size %>
          <%= f.text_field :size %><br>
        </div>

        <div class="field">
          <%= f.label :url %>
          <%= f.text_field :url %><br>
        </div>

        <div class="field">
          <%= f.label :photo %>
          <%= f.file_field :photo %><br>
        </div>

          <%= f.submit "Add Item" %>
        <% end %><!-- end of form_for -->

      <% else %>
        <p>You are not authorized to view this page.</p>
        <p><%= link_to "Go back", boxes_path %></p>
      <% end %><!-- end of current user try -->

      <p>
        <mark>**This box has not yet been shipped.**</mark> - <%= link_to "Ready to ship?", edit_box_path %>
      </p>
  <% end %><!-- end of if box.shipped statement -->
</p>

<p>
  <h5><%= link_to "Back to boxes", boxes_path %></h5>
  <h5><%= link_to 'Next', @box.next if @box.next %></h5>
</p>

<script type="text/javascript" charset="utf-8">

function Item(id, title, description, size, url) {
  this.id = id;
  this.title = title;
  this.description = description;
  this.size = size;
  this.url = url;
}

Item.prototype.urlFormatting = function () {
  var originalUrl = $("#item_url").val();
  if(originalUrl.includes("http") == true) {
    return originalUrl;
  } else if(originalUrl.includes("www") == true) {
    return "http://" + originalUrl;
  } else {
    return "http://" + "www." + originalUrl;
  }
}

// show the item details without refreshing page
  $(function() {
    $("a.load_items").on("click", function(e) {
      $.ajax({
        method: "GET",
        url: this.href
      }).done(function(response) {
        $("div.items").html(response);
      });
      e.preventDefault();
    }); // end of load items click function

// add a new item to the div without refreshing page
    $('form').on('submit', function(e) {
      e.preventDefault();
      data = $(this).serialize();
      // low level ajax
      // $.ajax({
      //   type: ($("input[name='_method']").val() || this.method),
      //   url: this.action, // this is the URL to submit the form data to /boxes/3/items
      //   data: data,
      //   success: function(response) {
      //     $("#item_title").val('');
      //     $("#item_description").val('');
      //     $("#item_size").val('');
      //     $("#item_url").val('');
      //
      //     var newItemInfo = new Item(
      //       $("#item_title").val(),
      //       $("#item_description").val(),
      //       $("#item_size").val(),
      //       $("#item_url").val()
      //     )
      //
      //     console.log(response)
      //     var $par = $("div.items ol")
      //     $par.append(response);
      //
      //
      //     var $itemUrl = $(".itemUrl")
      //     $itemUrl.html("New URL" + ' ' + newItemInfo.urlFormatting());
      //
      //   }
      // }); // end of ajax call
      //
      var url = this.action
      console.log(url)
      $.get(url).success(function(response) {
        var itemDiv = $("div.items ol");

        var newItemInfo = new Item(
          $("#item_title").val(),
          $("#item_description").val(),
          $("#item_size").val(),
          $("#item_url").val()
        );
      

        $(itemDiv).html("<li>" + newItemInfo.title + ": " + newItemInfo.description + ' ' + "(size: " + newItemInfo.size + ")"
          + newItemInfo.urlFormatting() + "</li>"

        );
      });

    }); // end of form on submit

  }); // end of document ready

</script>
